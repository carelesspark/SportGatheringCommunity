<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{/club/template/layout :: setContent(~{this :: content})}">
  <div class="container" th:fragment="content">


    <div class="mb-3">
      <h3 class="mb-3">클럽 생성</h3>

      <form action="/club/create" method="post">
        <input name="leaderId" required th:value="session.userId" type="hidden">

        <div class="row mb-3">
          <label class="col-sm-2 col-form-label" for="selectRegion">지역 선택</label>
          <div class="col-sm-10">
            <select class="form-select" id="selectRegion" name="regionId" required>
              <option th:each="region : ${regionList}"
                      th:text="${region.name}"
                      th:value="${region.id}">
              </option>
            </select>
          </div>
        </div>

        <div class="row mb-3">
          <label class="col-sm-2 col-form-label" for="selectSports">종목 선택</label>
          <div class="col-sm-10">
            <select class="form-select" id="selectSports" name="regionId" required>
              <option th:each="sports : ${sportsList}"
                      th:text="${sports.name}"
                      th:value="${sports.id}">
              </option>
            </select>
          </div>
        </div>

        <div class="row mb-3">
          <label class="col-sm-2 col-form-label" for="inputName">클럽명</label>
          <div class="col-sm-10">
            <input class="form-control" id="inputName" name="name" required type="text">
          </div>
        </div>

        <div class="row mb-3">
          <label class="col-sm-2 col-form-label" for="inputHeadline">헤드라인</label>
          <div class="col-sm-10">
            <input class="form-control" id="inputHeadline" name="headline" required type="text">
          </div>
        </div>

        <div class="row mb-3">
          <label class="col-sm-2 col-form-label" for="ckEditor">소개란</label>
          <div class="col-sm-10">
            <input class="form-control" id="ckEditor" name="introduce" required type="text">
          </div>
        </div>

        <div class="row mb-3">
          <label class="col-sm-2 col-form-label" for="inputImage">이미지</label>
          <div class="col-sm-10">
            <input class="custom-file-input files" id="inputImage" multiple type="file">
            <label class="custom-file-label" data-browse="Browse"></label>
          </div>
        </div>

        <div class="rounded box mb-3">

        </div>

        <div class="uploadResult">

        </div>

        <div>
          <button class="btn btn-primary" type="submit">클럽 생성</button>
        </div>
      </form>
    </div>

    <script src="https://cdn.ckeditor.com/ckeditor5/34.2.0/super-build/ckeditor.js"></script>
    <script th:src="@{/js/global/ckEditor.js}"></script>
    <script>
      $(function () {
        var regex = new RegExp("(.*?).(exe|sh|zip|alz|tiff)$");
        // 10 MB
        var maxSize = 10485760;

        // 파일 사이즈 및 확장자 검사
        function checkExt(fileName, fileSize) {
          if (fileSize >= maxSize) {
            alert("파일 사이즈 초과");
            return false;
          }
          if (regex.test(fileName)) {
            alert("해당 종류의 파일은 업로드 불가");
            return false;
          }

          return true;
        }

        // uploadResult class div에 업로드한 이미지 보여주기
        function showResult(uploadResultArr) {
          var uploadUL = $(".uploadResult ul");

          var str = "";
          $(uploadResultArr).each(function (idx, object) {
            str += "<li data-path='" + object.folderPath + "' ";
            str += "data-uuid='" + object.uuid + "' ";
            str += "data-name='" + object.fileName + "'>";

            str += "<div>";

            str += "<img src='/image/display?fileName=" + object.thumbnailURL + "'>";

            str +=
              "<button type='button' data-file='" +
              object.imageURL +
              "' class ='btn-warning btn-sm'>";

            str += "삭제";
            str += "</button>";

            str += "</div>";

            str += "</li>";
          });

          uploadUL.append(str);
        }

        $(".custom-file-input").on("change", function () {
          var fileName = $(this).val().split("\\").pop();

          var formData = new FormData();
          var inputFile = $(this);
          var files = inputFile[0].files;
          var appended = false;

          for (var i = 0; i < files.length; i++) {
            if (!checkExtension(files[i].name, files[i].size)) {
              return false;
            }

            formData.append("uploadFiles", files[i]);
            appended = true;
          }

          if (!appended) {
            return;
          }

          for (var value of formData.values()) {
            console.log(value);
          }

          $.ajax({
            url: "/image/upload/club",
            processData: false,
            contentType: false,
            data: formData,
            type: "POST",
            dataType: "JSON",
            success: function (result) {
              console.log(result);
              showResult(result);
            },
            error: function (jqXHR, textStatus, errorThrown) {
              console.log(textStatus);
            },
          });
        });

        $(".uploadResult").on("click", "ul li button", function () {
          // 물리적인 폴더에서 이미지 삭제
          var targetFile = $(this).data("file");
          // 화면에서 이미지 삭제
          var targetLi = $(this).closest("li");

          $.ajax({
            url: "/image/delete/club",
            data: { fileName: targetFile },
            type: "POST",
            success: function (data, textStatus) {
              alert(textStatus);
              targetLi.remove();
            },
          });
        });

        $(".submitBtn").on("click", function (event) {
          // <a>, submit 등에서 click 이벤트를 직접 적용할 때 사용
          event.preventDefault();

          var str = "";
          $(".uploadResult li").each(function (idx, obj) {
            var target = $(obj);

            str += "<input type='hidden' name='imageDTOList[";
            str += idx;
            str += "].path' value='";
            str += target.data("path");
            str += "'>";

            str += "<input type='hidden' name='imageDTOList[";
            str += idx;
            str += "].uuid' value='";
            str += target.data("uuid");
            str += "'>";

            str += "<input type='hidden' name='imageDTOList[";
            str += idx;
            str += "].name' value='";
            str += target.data("name");
            str += "'>";
          });
          $(".box").html(str);

          $("form").submit();
          $("form").reset();
        });
      });
    </script>
  </div>
</th:block>

</html>

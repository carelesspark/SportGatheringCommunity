<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{/club/template/club :: setContent(~{this :: content})}">
  <div class="container" th:fragment="content">

    <div class="mb-4 d-flex justify-content-between align-items-center">
      <div>
        <h3>ê°€ì…ì¸ì‚¬</h3>
      </div>
      <div th:if="${myGreetingsId == null}">
        <a class="btn btn-primary" th:href="@{/club/greetingsForm(clubId=${navDTO.clubId})}">
          ê°€ì…ì¸ì‚¬ ì‘ì„±
        </a>
      </div>
      <div th:if="${myGreetingsId != null && checkUserId == null}">
        <form action="/club/greetings" method="get">
          <input name="clubId" th:value="${navDTO.clubId}" type="hidden">
          <input name="userId" th:value="${session.userId}" type="hidden">
          <button class="btn btn-info" type="submit">
            ë‚˜ì˜ ê°€ì…ì¸ì‚¬
          </button>
        </form>
      </div>
      <div th:if="${checkUserId != null}">
        <form action="/club/greetings" method="get">
          <input name="clubId" th:value="${navDTO.clubId}" type="hidden">
          <button class="btn btn-info" type="submit">
            ì „ì²´ ê°€ì…ì¸ì‚¬
          </button>
        </form>
      </div>
    </div>

    <div class="mb-3" th:if="${result != null}">
      <div class="card mb-2" th:each="dto : ${result.dtoList}">
        <div class="card-body">
          <div class="d-flex flex-column mb-3">
            <div>
              <h5 class="card-title">[[${dto.memberName}]]</h5>
              <p class="card-text">[[${dto.content}]]</p>
            </div>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center" th:id="'likeDiv'+${dtoStat.index}">
              <a th:if="${dto.greetingsId == myGreetingsId}">
                ğŸ§¡
              </a>
              <a th:if="${dto.greetingsId != myGreetingsId}"
                 th:onclick="increaseLike([[${dto.greetingsId}]], [[${dtoStat.index}]])"
                 th:style="${dto.clicked} ? 'display: none;' : ''">
                ğŸ’–
              </a>
              <a th:if="${dto.greetingsId != myGreetingsId}"
                 th:onclick="decreaseLike([[${dto.greetingsId}]], [[${dtoStat.index}]])"
                 th:style="${!dto.clicked} ? 'display: none;' : ''">
                ğŸ’–
              </a>
              <div th:id="'likeCount'+${dtoStat.index}">ì¢‹ì•„ìš” [[${dto.likeCount}]]ê°œ</div>
            </div>
            <div th:if="${dto.greetingsId == myGreetingsId}">
              <a class="btn btn-secondary"
                 th:href="@{/club/greetingsForm(clubId=${navDTO.clubId}, greetingsId=${dto.greetingsId})}">ìˆ˜ì •í•˜ê¸°</a>
            </div>
          </div>
        </div>
      </div>

      <div>
        <ul class="pagination h-100 justify-content-center align-items-center">
          <li class="page-item" th:if="${result.prev}">
            <a class="page-link" th:href="@{/club/greetings(
            page = ${result.start - 1},
            clubId = ${navDTO.clubId}
            )}">
              â€¹
            </a>
          </li>

          <li th:class="'page-item ' + ${result.page == page ? 'active' : ''}"
              th:each="page : ${result.pageList}">
            <a class="page-link" th:href="@{/club/greetings(
            page = ${page},
            clubId = ${navDTO.clubId}
            )}">
              [[${page}]]
            </a>
          </li>

          <li class="page-item" th:if="${result.next}">
            <a class="page-link" th:href="@{/club/greetings(
            page = ${result.end + 1},
            clubId = ${navDTO.clubId}
            )}">
              â€º
            </a>
          </li>
        </ul>
      </div>
    </div>

    <script th:inline="javascript">
      $(function () {

        // ì¢‹ì•„ìš” ì¦ê°€
        increaseLike = function (greetingsId, index) {
          $.ajax({
            type: "POST",
            url: "/greetings/increaseLike",
            data: {
              greetingsId: greetingsId,
              clubId: [[${navDTO.clubId}]],
            },
            success: function (response, status, xhr) {
              if(xhr.status === 201) {
                alert("ì¢‹ì•„ìš”ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤. GreetingsId: " + greetingsId);
                // decreaseLikeê°€ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ 'ğŸ¤' ë²„íŠ¼ì„ ë³´ì´ë„ë¡ í•¨
                $("#likeDiv" + index + " a:nth-child(1)").show();
                // increaseLikeëŠ” ì„±ê³µí•˜ë©´ 'â¤' ë²„íŠ¼ì„ ìˆ¨ê¹€
                $("#likeDiv" + index + " a:nth-child(2)").hide();
              } else if (xhr.status === 20) {
                alert("ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ìŠµë‹ˆë‹¤. GreetingsId: " + greetingsId);
                // increaseLikeê°€ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ 'â¤' ë²„íŠ¼ì„ ë³´ì´ë„ë¡ í•¨
                $("#likeDiv" + index + " a:nth-child(2)").show();
                // decreaseLikeëŠ” ì„±ê³µí•˜ë©´ 'ğŸ¤' ë²„íŠ¼ì„ ìˆ¨ê¹€
                $("#likeDiv" + index + " a:nth-child(1)").hide();
              }
              // í´ë¼ì´ì–¸íŠ¸ì—ì„œ likeCount ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸
              var likeCount = response.likeCount;
              // ì¢‹ì•„ìš” ë²„íŠ¼ì„ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ë“±ì˜ ì¶”ê°€ ì‘ì—… ìˆ˜í–‰
              $("#likeCount" + index).text("ì¢‹ì•„ìš” " + likeCount + "ê°œ");
            },
            error: function (xhr, status, error) {
              console.error("ì¢‹ì•„ìš” ì¦ê°€ ì‹¤íŒ¨: ", error);
            },
          });
        }

        // ì¢‹ì•„ìš” ê°ì†Œ
        decreaseLike = function (greetingsId, index) {
          $.ajax({
            type: "DELETE",
            url: "/greetings/decreaseLike",
            data: {
              greetingsId: greetingsId,
              clubId: [[${navDTO.clubId}]],
            },
            success: function (response) {
              alert("ì¢‹ì•„ìš”ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤. GreetingsId: " + greetingsId);
              // decreaseLikeê°€ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ 'ğŸ¤' ë²„íŠ¼ì„ ë³´ì´ë„ë¡ í•¨
              $("#likeDiv" + index + " a:nth-child(1)").show();
              // increaseLikeëŠ” ì„±ê³µí•˜ë©´ 'â¤' ë²„íŠ¼ì„ ìˆ¨ê¹€
              $("#likeDiv" + index + " a:nth-child(2)").hide();
              // í´ë¼ì´ì–¸íŠ¸ì—ì„œ likeCount ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸
              var likeCount = response.likeCount;
              // ì¢‹ì•„ìš” ë²„íŠ¼ì„ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ë“±ì˜ ì¶”ê°€ ì‘ì—… ìˆ˜í–‰
              $("#likeCount" + index).text("ì¢‹ì•„ìš” " + likeCount + "ê°œ");
            },
            error: function (xhr, status, error) {
              console.error("ì¢‹ì•„ìš” ê°ì†Œ ì‹¤íŒ¨  : ", error);
            },
          });
        }

      });
    </script>
  </div>
</th:block>
</html>